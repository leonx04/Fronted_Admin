<!DOCTYPE html>
<div ng-controller="PromotionsController">
    <div id="loading-overlay" ng-show="isLoading">
        <div class="spinner"></div>
    </div>

    <div class="container-fluid mt-4">
        <h2 class="mb-4 text-primary"><i class="fas fa-fw fa-percent"></i>Quản lý Khuyến mãi</h2>

        <!-- Search Form -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Tìm kiếm Khuyến mãi</h6>
            </div>
            <div class="card-body">
                <form ng-submit="searchPromotions()">
                    <!-- Row 1 -->
                    <div class="row">
                        <div class="form-group col-sm-6 col-md-3">
                            <label for="searchCode">Mã khuyến mãi</label>
                            <input type="text" class="form-control" id="searchCode" ng-model="searchParams.code"
                                placeholder="Nhập mã khuyến mãi">
                        </div>
                        <div class="form-group col-sm-6 col-md-3">
                            <label for="searchName">Tên khuyến mãi</label>
                            <input type="text" class="form-control" id="searchName" ng-model="searchParams.name"
                                placeholder="Nhập tên khuyến mãi">
                        </div>
                        <div class="form-group col-sm-6 col-md-3">
                            <label for="searchStartDate">Ngày bắt đầu</label>
                            <input type="datetime-local" class="form-control" id="searchStartDate"
                                ng-model="searchParams.startDate">
                        </div>
                        <div class="form-group col-sm-6 col-md-3">
                            <label for="searchEndDate">Ngày kết thúc</label>
                            <input type="datetime-local" class="form-control" id="searchEndDate"
                                ng-model="searchParams.endDate">
                        </div>
                    </div>
                    <!-- Row 2 (Buttons) -->
                    <div class="row">
                        <div class="col-12 d-flex flex-wrap justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-primary mb-2">
                                    <i class="fas fa-search mr-2"></i>Tìm kiếm
                                </button>
                                <button type="button" class="btn btn-secondary ml-2 mb-2" ng-click="resetForm()">
                                    <i class="fas fa-undo mr-2"></i>Đặt lại
                                </button>
                            </div>
                            <a href="#!/add-promotion" class="btn btn-success mb-2">
                                <i class="fas fa-plus mr-2"></i>Thêm khuyến mãi
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>


        <!-- Promotions List -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Danh sách Khuyến mãi</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>Mã</th>
                                <th>Tên</th>
                                <th>Giá trị</th>
                                <th>Ngày bắt đầu</th>
                                <th>Ngày kết thúc</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="promotion in promotions">
                                <td class="align-middle">{{promotion.code}}</td>
                                <td class="align-middle">{{promotion.name}}</td>
                                <td class="align-middle">{{promotion.discountPercentage}}%</td>
                                <td class="align-middle">{{promotion.startDate | date:'dd/MM/yyyy HH:mm:ss'}}</td>
                                <td class="align-middle">{{promotion.endDate | date:'dd/MM/yyyy HH:mm:ss'}}</td>
                                <td class="align-middle">
                                    <div class="d-flex align-items-center">
                                        <span class="badge badge-success mr-1" ng-if="promotion.status === 1">
                                            <i class="fas fa-check-circle mr-1"></i>
                                            Đang hoạt động
                                        </span>
                                        <span class="badge badge-danger mr-1" ng-if="promotion.status === 2">
                                            <i class="fas fa-times-circle mr-1"></i>
                                            Không hoạt động
                                        </span>
                                        <span class="badge badge-warning mr-1" ng-if="promotion.status === 3">
                                            <i class="fas fa-hourglass-half mr-1"></i>
                                            Sắp bắt đầu
                                        </span>
                                        <span class="badge badge-secondary mr-1" ng-if="promotion.status === 4">
                                            <i class="fas fa-calendar-times mr-1"></i>
                                            Đã kết thúc
                                        </span>
                                    </div>
                                </td>
                                <td class="align-middle">
                                    <button class="btn btn-info btn-sm" ng-click="viewPromotionDetails(promotion.id)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-primary mr-1" ng-click="editPromotion(promotion.id)"
                                        ng-if="promotion.status !== 2 && promotion.status !== 4 && promotion.status !== 3 "><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-danger"
                                        ng-click="openDeleteConfirmModal(promotion.id)" ng-if="promotion.status !== 2 && promotion.status !== 4 && promotion.status !== 3 && promotion.status !== 1"><i
                                            class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <p class="mb-0">
                        Showing {{currentPage * pageSize + 1}} to {{Math.min((currentPage + 1) * pageSize, totalItems)}}
                        of {{totalItems}} entries
                    </p>
                    <nav aria-label="Page navigation" class="pagination-sm">
                        <ul class="pagination mb-0">
                            <li class="page-item" ng-class="{'disabled': currentPage === 0}">
                                <a class="page-link" href ng-click="changePage(currentPage - 1)" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item" ng-class="{'active': currentPage === 0}" ng-if="totalPages > 0">
                                <a class="page-link" href ng-click="changePage(0)">1</a>
                            </li>
                            <li class="page-item disabled" ng-if="currentPage > 2">
                                <span class="page-link">...</span>
                            </li>
                            <li class="page-item" ng-class="{'active': currentPage === page}"
                                ng-repeat="page in getPageRange()" ng-if="page !== 0 && page !== totalPages - 1">
                                <a class="page-link" href ng-click="changePage(page)">{{page + 1}}</a>
                            </li>
                            <li class="page-item disabled" ng-if="currentPage < totalPages - 3">
                                <span class="page-link">...</span>
                            </li>
                            <li class="page-item" ng-class="{'active': currentPage === totalPages - 1}"
                                ng-if="totalPages > 1">
                                <a class="page-link" href ng-click="changePage(totalPages - 1)">{{totalPages}}</a>
                            </li>
                            <li class="page-item" ng-class="{'disabled': currentPage === totalPages - 1}">
                                <a class="page-link" href ng-click="changePage(currentPage + 1)" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div class="modal fade" id="PromotionModal" tabindex="-1" role="dialog" aria-labelledby="promotionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="promotionModalLabel">{{isEditing ? 'Chỉnh Sửa' : 'Thêm'}} Khuyến mãi
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="code">Mã khuyến mãi</label>
                                <input type="text" class="form-control" id="code" ng-model="promotionData.code"
                                    required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="name">Tên khuyến mãi</label>
                                <input type="text" class="form-control" id="name" ng-model="promotionData.name"
                                    required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="startDate">Ngày bắt đầu</label>
                                <input type="datetime-local" id="startDate" name="startDate" class="form-control"
                                    ng-model="promotionData.startDate" step="1" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="endDate">Ngày kết thúc</label>
                                <input type="datetime-local" id="endDate" name="endDate" class="form-control"
                                    ng-model="promotionData.endDate" step="1" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="discountPercentage">Giá trị giảm giá (%)</label>
                                <input type="number" step="0.01" class="form-control" id="discountPercentage"
                                    ng-model="promotionData.discountPercentage" required>
                            </div>
                            <div class="form-group col-md-6" ng-if="isEditing">
                                <label for="status">Trạng thái</label>
                                <select class="form-control" id="status" ng-model="promotionData.status">
                                    <option value="1">Hoạt động</option>
                                    <!-- <option value="3">Chờ hoạt động</option> -->
                                    <option value="2">Không hoạt động</option>
                                    <!-- <option value="4">Hết hạn</option> -->
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" ng-click="savePromotion()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog"
        aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Xác nhận xóa</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn xóa khuyến mãi này không?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" ng-click="deletePromotion()">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <div id="promotionDetailsModal" class="modal fade" tabindex="-1" role="dialog"
        aria-labelledby="promotionDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="promotionDetailsModalLabel">
                        <i class="fas fa-info-circle mr-2"></i>Chi tiết khuyến mãi
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div ng-if="promotionDetails">
                        <h6><i class="fas fa-tag mr-2"></i>Thông tin khuyến mãi</h6>
                        <p><strong>Mã khuyến mãi:</strong> {{promotionDetails.code}}</p>
                        <p><strong>Tên khuyến mãi:</strong> {{promotionDetails.name}}</p>
                        <p><strong>Giảm giá:</strong> {{promotionDetails.discountPercentage}}%</p>
                        <p><strong>Ngày bắt đầu:</strong> {{promotionDetails.startDate | date:'dd/MM/yyyy HH:mm:ss'}}
                        </p>
                        <p><strong>Ngày kết thúc:</strong> {{promotionDetails.endDate | date:'dd/MM/yyyy HH:mm:ss'}}</p>
                    </div>

                    <h6 class="mt-4"><i class="fas fa-box-open mr-2"></i>Sản phẩm áp dụng</h6>
                    <div ng-if="hasProducts">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Tên sản phẩm</th>
                                    <th>Màu sắc</th>
                                    <th>Kích thước</th>
                                    <th>Giá gốc</th>
                                    <th>Giá khuyến mãi</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="product in promotionProducts">
                                    <td>{{product.product.name}}</td>
                                    <td>{{product.color.name}}</td>
                                    <td>{{product.size.name}}</td>
                                    <td class="discounted-price">{{formatCurrency(product.price)}}</td>
                                    <td class="promotion-price">{{formatCurrency(product.price * (1 - promotionDetails.discountPercentage/100))}}</td>
                                    <td>
                                        <span class="badge badge-success mr-1" ng-if="product.product.status === 1">
                                            <i class="fas fa-check-circle mr-1"></i>
                                            Còn hàng
                                        </span>
                                        <span class="badge badge-danger mr-1" ng-if="product.product.status === 0">
                                            <i class="fas fa-times-circle mr-1"></i>
                                            Hết hàng
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div ng-if="!hasProducts" class="alert alert-info">
                        <i class="fas fa-exclamation-circle mr-2"></i>Chưa có sản phẩm chi tiết nào được áp dụng cho
                        khuyến mãi này.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-2"></i>Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>